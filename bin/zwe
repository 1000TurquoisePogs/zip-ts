#!/bin/sh

#######################################################################
# This program and the accompanying materials are made available
# under the terms of the Eclipse Public License v2.0 which
# accompanies this distribution, and is available at
# https://www.eclipse.org/legal/epl-v20.html
#
# SPDX-License-Identifier: EPL-2.0
#
# Copyright Contributors to the Zowe Project.
#######################################################################

#######################################################################
# central handle for all Zowe commands

#######################################################################
# Constants
ZOWE_RUNTIME_DIRECTORY=$(cd $(dirname $0)/../;pwd)

#######################################################################
# import all shared libraries
. ${ZOWE_RUNTIME_DIRECTORY}/bin/libs/index.sh

#######################################################################
# parse parameters
zwecli_load_parameters_definition
while [ $# -gt 0 ]; do
  arg="$1"
  if [[ "${arg}" == -* ]] || [[ "${arg}" == --* ]]; then
    definition=$(zwecli_locate_parameter_definition $arg)
    if [ $? -gt 0 ]; then
      >&2 echo "Error: invalid parameter ${arg}"
      exit 1
    fi
    param_id=$(echo "${definition}" | awk -F"|" '{print $1}' | awk -F, '{print $1}')
    param_type=$(echo "${definition}" | awk -F"|" '{print $3}' | lower_case)
    param_var=$(echo "ZWECLI_PARAMETER_${param_id}" | upper_case | sanitize_alphanum)
    if [ "${param_type}" = "b" -o "${param_type}" = "bool" -o "${param_type}" = "boolean" ]; then
      ZWECLI_PARAMETERS_LIST=$(trim "${ZWECLI_PARAMETERS_LIST} ${param_id}")
      eval "${param_var}=true"
    elif [ "${param_type}" = "s" -o "${param_type}" = "str" -o "${param_type}" = "string" ]; then
      shift
      ZWECLI_PARAMETERS_LIST=$(trim "${ZWECLI_PARAMETERS_LIST} ${param_id}")
      eval "${param_var}=\"${1}\""
    else
      >&2 echo "Error: invalid parameter type of ${arg}"
      exit 1
    fi
  else
    ZWECLI_COMMANDS_LIST=$(trim "${ZWECLI_COMMANDS_LIST} ${arg}")
    zwecli_load_parameters_definition
  fi
  shift
done

#######################################################################
# process
zwecli_process_loglevel
# if it's in help mode, the script will exit with code 99
zwecli_process_help
# validate parameter before execute command
zwecli_validate_parameters
# handle command
zwecli_process_command
